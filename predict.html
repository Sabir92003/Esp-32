<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Pro AI Forecast Dashboard</title>
  
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/hammerjs@2.0.8"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-zoom@2.0.1"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

  <style>
    :root {
      --bg: #0f172a; --card: rgba(30, 41, 59, 0.7); --text: #f8fafc;
      --border: #334155; --accent: #38bdf8; --glass: blur(10px);
    }
    [data-theme="light"] {
      --bg: #f8fafc; --card: rgba(255, 255, 255, 0.8); --text: #0f172a;
      --border: #cbd5e1; --accent: #0284c7;
    }
    body { 
      font-family: 'Segoe UI', system-ui, sans-serif; 
      margin: 0; padding: 0; background: var(--bg); color: var(--text); 
      transition: background 0.4s ease; min-height: 100vh;
    }

    /* --- NEW NAVIGATION BAR STYLES --- */
    .top-nav {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px 20px;
      background: var(--card);
      backdrop-filter: var(--glass);
      border-bottom: 1px solid var(--border);
      position: sticky;
      top: 0;
      z-index: 1000;
    }
    .nav-group { display: flex; gap: 10px; }
    .nav-link {
      text-decoration: none;
      padding: 8px 16px;
      border-radius: 8px;
      border: 1px solid var(--accent);
      color: var(--accent);
      font-weight: 600;
      transition: all 0.3s ease;
      font-size: 0.9rem;
    }
    .nav-link:hover {
      background: var(--accent);
      color: white;
      box-shadow: 0 0 15px rgba(56, 189, 248, 0.4);
    }
    .chat-btn {
      background: rgba(56, 189, 248, 0.1);
    }

    .header { 
      padding: 30px; text-align: center; 
      border-bottom: 1px solid var(--border);
    }
    .grid { display: grid; grid-template-columns: 1fr; gap: 20px; width: 100%; padding: 20px; box-sizing: border-box; }
    
    @media (min-width: 768px) {
      .grid { grid-template-columns: 1fr 1fr; }
    }

    .card { 
      background: var(--card); backdrop-filter: var(--glass);
      padding: 25px; border-radius: 16px; border: 1px solid var(--border); 
      position: relative;
    }
    .val-display { font-size: 2.5rem; font-weight: 800; color: var(--accent); margin: 10px 0; }
    canvas { width: 100% !important; height: 320px !important; cursor: crosshair; }
    .controls { position: absolute; top: 20px; right: 20px; }
    .btn {
      padding: 6px 12px; border-radius: 8px; border: 1px solid var(--accent);
      background: transparent; color: var(--accent); cursor: pointer; font-weight: 600;
    }
    .theme-toggle {
      position: fixed; bottom: 20px; left: 20px; z-index: 1000;
      width: 50px; height: 50px; border-radius: 50%; background: var(--accent);
      border: none; color: white; cursor: pointer; font-size: 1.2rem;
    }
    .forecast-note { font-weight: 600; color: var(--accent); margin-top: 15px; border-top: 1px solid var(--border); padding-top: 10px; }
  </style>
</head>

<body>

<nav class="top-nav">
    <a href="third.html" class="nav-link">‚¨Ö Back</a>
    <div class="nav-group">
        <a href="Chat boat.html" class="nav-link chat-btn">ü§ñ AI Chatbot</a>
    </div>
</nav>

<button class="theme-toggle" onclick="toggleTheme()">üåì</button>

<div class="header">
    <h1>üîÆ Pro AI Forecast Dashboard</h1>
    <p>Left Half: Recorded Data | Right Half: 24h AI Prediction</p>
</div>

<div class="grid">
    <div class="card">
        <div class="controls"><button class="btn" onclick="resetZoom('temp')">Reset View</button></div>
        <h3>üå°Ô∏è Temperature (¬∞C)</h3>
        <div id="v_temp" class="val-display">--.-¬∞C</div>
        <canvas id="c_temp"></canvas>
        <p class="forecast-note" id="p_temp">Analyzing trends...</p>
    </div>

    <div class="card">
        <div class="controls"><button class="btn" onclick="resetZoom('hum')">Reset View</button></div>
        <h3>üíß Humidity (%)</h3>
        <div id="v_hum" class="val-display">--.-%</div>
        <canvas id="c_hum"></canvas>
        <p class="forecast-note" id="p_hum">Analyzing trends...</p>
    </div>

    <div class="card">
        <div class="controls"><button class="btn" onclick="resetZoom('co2')">Reset View</button></div>
        <h3>‚òÅÔ∏è Carbon Dioxide (ppm)</h3>
        <div id="v_co2" class="val-display">---- ppm</div>
        <canvas id="c_co2"></canvas>
        <p class="forecast-note" id="p_co2">Analyzing trends...</p>
    </div>

    <div class="card">
        <div class="controls"><button class="btn" onclick="resetZoom('voc')">Reset View</button></div>
        <h3>üß™ Air Quality (ppb)</h3>
        <div id="v_voc" class="val-display">---- ppb</div>
        <canvas id="c_voc"></canvas>
        <p class="forecast-note" id="p_voc">Analyzing trends...</p>
    </div>
</div>

<script>
const firebaseConfig = { databaseURL: "https://esp32-dht22-1dcca-default-rtdb.firebaseio.com/" };
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

function toggleTheme() {
    const isLight = document.documentElement.getAttribute('data-theme') === 'light';
    document.documentElement.setAttribute('data-theme', isLight ? 'dark' : 'light');
}

const createChart = (ctxId, color) => {
    return new Chart(document.getElementById(ctxId), {
        type: 'line',
        data: { labels: [], datasets: [
            { label: 'Past 24h', data: [], borderColor: color, tension: 0.4, fill: false, borderWidth: 4, pointRadius: 2 },
            { label: 'AI Forecast', data: [], borderColor: color, borderDash: [8, 4], tension: 0.4, fill: true, backgroundColor: color + '22', pointRadius: 0 }
        ]},
        options: {
            responsive: true,
            maintainAspectRatio: false,
            interaction: { mode: 'index', intersect: false },
            plugins: { 
                tooltip: { enabled: true, backgroundColor: 'rgba(15, 23, 42, 0.9)', padding: 12 },
                zoom: {
                    zoom: { wheel: { enabled: true }, pinch: { enabled: true }, mode: 'x' },
                    pan: { enabled: true, mode: 'x' }
                }
            },
            scales: { 
                x: { ticks: { color: '#94a3b8', maxTicksLimit: 10 } },
                y: { ticks: { color: '#94a3b8' } }
            }
        }
    });
};

const charts = {
    temp: createChart('c_temp', '#f87171'),
    hum: createChart('c_hum', '#38bdf8'),
    co2: createChart('c_co2', '#fbbf24'),
    voc: createChart('c_voc', '#a78bfa')
};

function resetZoom(key) { charts[key].resetZoom(); }

function calculatePrediction(pastData, steps) {
    if (pastData.length < 2) return [];
    const lastPoint = pastData[pastData.length - 1];
    const secondLast = pastData[pastData.length - 2];
    const trend = lastPoint - secondLast; 
    
    let prediction = [];
    for (let i = 1; i <= steps; i++) {
        let cycle = Math.sin((i * Math.PI) / 12) * 2; 
        prediction.push(lastPoint + (trend * i * 0.2) + cycle);
    }
    return prediction;
}

db.ref("esp32_history").limitToLast(24).on("value", (snapshot) => {
    let raw = { temp:[], hum:[], co2:[], voc:[], labels:[] };
    snapshot.forEach(child => {
        const d = child.val();
        raw.temp.push(d.temperature);
        raw.hum.push(d.humidity);
        raw.co2.push(d.eCO2 || 0);
        raw.voc.push(d.TVOC || 0);
        raw.labels.push(d.log_time ? d.log_time.split(' ')[1].substring(0,5) : "Past");
    });

    const now = new Date();
    Object.keys(charts).forEach(key => {
        const chart = charts[key];
        const dataArr = raw[key];
        const lastVal = dataArr[dataArr.length-1] || 0;
        const unit = key==='temp'?'¬∞C':key==='hum'?'%':key==='co2'?' ppm':' ppb';
        
        document.getElementById(`v_${key}`).innerText = lastVal.toFixed(1) + unit;

        const forecastValues = calculatePrediction(dataArr, 24);
        let displayForecast = new Array(dataArr.length - 1).fill(null);
        displayForecast.push(lastVal);
        displayForecast = displayForecast.concat(forecastValues);

        let futureLabels = [...raw.labels];
        for(let i=1; i<=24; i++) {
            let fut = new Date(now.getTime() + i * 3600000);
            futureLabels.push("üîÆ " + fut.getHours() + ":00");
        }

        chart.data.labels = futureLabels;
        chart.data.datasets[0].data = dataArr;
        chart.data.datasets[1].data = displayForecast;
        
        const finalEst = forecastValues.length > 0 ? forecastValues[23].toFixed(1) : "--";
        document.getElementById(`p_${key}`).innerHTML = `AI Estimated for tomorrow: <b>${finalEst}${unit}</b>`;
        chart.update('none');
    });
});
</script>
</body>
</html>
