<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Persistent ESP32 Air Dashboard</title>
  
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

  <style>
    body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; margin: 20px; background:#f4f6f8; color: #333; }
    h2 { text-align:center; color: #2c3e50; }
    .card {
      border: 1px solid #ddd; padding: 20px; border-radius: 12px;
      margin-bottom: 20px; background: white; box-shadow: 0 4px 12px rgba(0,0,0,0.08);
    }
    #readings { font-size: 1.1rem; line-height: 1.6; color: #16a085; font-weight: bold; }
    .btn-back { padding: 10px 20px; background: #95a5a6; color: white; text-decoration: none; border-radius: 5px; display: inline-block; margin-bottom: 20px; }
    canvas { max-height: 250px; }
    
    .search-box { display: flex; gap: 10px; margin-bottom: 20px; }
    input { flex: 1; padding: 10px; border: 1px solid #ccc; border-radius: 5px; }
    .btn-add { padding: 10px 20px; background: #27ae60; color: white; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; }
    table { width:100%; border-collapse: collapse; text-align:center; }
    th, td { border:1px solid #eee; padding:10px; }
    .aqi-pill { padding: 4px 10px; border-radius: 12px; color: white; font-weight: bold; font-size: 0.85rem; }
    .delete-btn { color: #e74c3c; cursor: pointer; font-weight: bold; border: none; background: none; }

    .btn-nav { 
      float: right; font-size: 18px; font-weight: bold; padding: 12px 24px; 
      background: #2c3e50; color: white; border: none; border-radius: 8px; 
      cursor: pointer; margin-top: 20px; transition: 0.3s;
    }
    .btn-clear { background: #e67e22; color: white; padding: 5px 10px; border: none; border-radius: 5px; cursor: pointer; margin-bottom: 10px; font-size: 0.8rem;}
  </style>
</head>

<body>

<a href="second1.html" class="btn-back">‚¨Ö Tem/Hum</a>
<h2>Air Quality Intelligence Dashboard</h2>

<div class="card">
  <h3>üè† Room Air Status (Live)</h3>
  <div id="readings">Connecting to Firebase...</div>
</div>

<div class="card">
  <h3>eCO2 Trend (ppm) <button class="btn-clear" onclick="clearHistory('co2')">Reset Graph</button></h3>
  <canvas id="co2Chart"></canvas>
</div>

<div class="card">
  <h3>TVOC Trend (ppb) <button class="btn-clear" onclick="clearHistory('tvoc')">Reset Graph</button></h3>
  <canvas id="tvocChart"></canvas>
</div>

<div class="card">
  <h3>üåç City-Wise Air Monitoring</h3>
  <div class="search-box">
    <input type="text" id="citySearch" placeholder="Enter city (e.g. Delhi, London)">
    <button class="btn-add" onclick="addNewCity()">Add City</button>
  </div>
  <table>
    <thead>
      <tr style="background:#ecf0f1;">
        <th>City / Station</th>
        <th>AQI</th>
        <th>NO‚ÇÇ (ppb)</th>
        <th>PM2.5</th>
        <th>Action</th>
      </tr>
    </thead>
    <tbody id="cityTableBody"></tbody>
  </table>
  <p id="city-sync" style="font-size: 0.8rem; color: gray; text-align: right; margin-top: 10px;">Syncing...</p>
</div>

<button class="btn-nav" onclick="location.href='third.html'">Go to PH Page</button>

<script>
/* ===================== STORAGE LOGIC ===================== */
// Function to load data from browser storage
function getStoredData(key) {
    const saved = localStorage.getItem(key);
    return saved ? JSON.parse(saved) : { labels: [], data: [] };
}

// Function to reset history
function clearHistory(type) {
    if(confirm("Clear this graph's history?")) {
        localStorage.removeItem(type + '_logs');
        location.reload();
    }
}

let co2Stored = getStoredData('co2_logs');
let tvocStored = getStoredData('tvoc_logs');

/* ===================== FIREBASE & CHART CODE ===================== */
const firebaseConfig = { databaseURL: "https://esp32-dht22-1dcca-default-rtdb.firebaseio.com/" };
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

const commonOptions = { 
    responsive: true, maintainAspectRatio: false, animation: false,
    scales: { x: { display: true } } 
};

const co2Chart = new Chart(document.getElementById('co2Chart'), {
    type: 'line',
    data: { 
        labels: co2Stored.labels, 
        datasets: [{ label: 'eCO2 (ppm)', data: co2Stored.data, borderColor: '#27ae60', fill: true, backgroundColor: 'rgba(39, 174, 96, 0.1)' }] 
    },
    options: commonOptions
});

const tvocChart = new Chart(document.getElementById('tvocChart'), {
    type: 'line',
    data: { 
        labels: tvocStored.labels, 
        datasets: [{ label: 'TVOC (ppb)', data: tvocStored.data, borderColor: '#8e44ad', fill: true, backgroundColor: 'rgba(142, 68, 173, 0.1)' }] 
    },
    options: commonOptions
});

db.ref("esp32").on("value", (snapshot) => {
    const data = snapshot.val();
    if (!data) return;
    const ts = new Date().toLocaleTimeString();
    
    document.getElementById('readings').innerHTML = `
        üçÉ <strong>eCO2:</strong> ${data.eCO2 ?? '--'} ppm | 
        üß™ <strong>TVOC:</strong> ${data.TVOC ?? '--'} ppb 
    `;

    // Update eCO2 Array
    co2Chart.data.labels.push(ts);
    co2Chart.data.datasets[0].data.push(data.eCO2);
    if (co2Chart.data.labels.length > 30) { co2Chart.data.labels.shift(); co2Chart.data.datasets[0].data.shift(); }
    co2Chart.update();
    localStorage.setItem('co2_logs', JSON.stringify({labels: co2Chart.data.labels, data: co2Chart.data.datasets[0].data}));

    // Update TVOC Array
    tvocChart.data.labels.push(ts);
    tvocChart.data.datasets[0].data.push(data.TVOC);
    if (tvocChart.data.labels.length > 30) { tvocChart.data.labels.shift(); tvocChart.data.datasets[0].data.shift(); }
    tvocChart.update();
    localStorage.setItem('tvoc_logs', JSON.stringify({labels: tvocChart.data.labels, data: tvocChart.data.datasets[0].data}));
});

/* ===================== CITY AIR QUALITY LOGIC (AQICN) ===================== */
const AQI_TOKEN = "36a14316c00d4a453e7ca5137359c3b851dd7f92";
let myCities = ["Delhi", "Mumbai", "London"]; 

async function refreshAllCities() {
    const tableBody = document.getElementById('cityTableBody');
    tableBody.innerHTML = ""; 
    for (let city of myCities) {
        try {
            const searchRes = await fetch(`https://api.waqi.info/search/?token=${AQI_TOKEN}&keyword=${city}`);
            const searchData = await searchRes.json();
            
            if (searchData.status === "ok" && searchData.data.length > 0) {
                const uid = searchData.data[0].uid;
                const feedRes = await fetch(`https://api.waqi.info/feed/@${uid}/?token=${AQI_TOKEN}`);
                const feedData = await feedRes.json();
                const d = feedData.data;

                const aqi = d.aqi;
                const no2 = d.iaqi.no2 ? d.iaqi.no2.v : "--";
                const pm25 = d.iaqi.pm25 ? d.iaqi.pm25.v : "--";
                
                let aqiColor = aqi > 100 ? "#e67e22" : "#27ae60";
                if (aqi > 200) aqiColor = "#c0392b";

                tableBody.innerHTML += `<tr>
                    <td><strong>${d.city.name}</strong></td>
                    <td><span class="aqi-pill" style="background:${aqiColor}">${aqi}</span></td>
                    <td>${no2}</td>
                    <td>${pm25}</td>
                    <td><button class="delete-btn" onclick="removeCity('${city}')">Remove</button></td>
                </tr>`;
            }
        } catch (e) { console.error("Error fetching " + city); }
    }
    document.getElementById('city-sync').innerText = "Auto-Sync: " + new Date().toLocaleTimeString();
}

function addNewCity() {
    const input = document.getElementById('citySearch');
    if (input.value && !myCities.includes(input.value)) {
        myCities.push(input.value);
        input.value = ""; 
        refreshAllCities();
    }
}

function removeCity(city) {
    myCities = myCities.filter(c => c !== city);
    refreshAllCities();
}

refreshAllCities();
setInterval(refreshAllCities, 300000); 
</script>
</body>
</html>

