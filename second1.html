<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ESP32 Station Dashboard</title>
  
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

  <style>
    body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; margin: 20px; background:#f4f6f8; color: #333; }
    h2 { text-align:center; color: #2c3e50; }
    .card {
      border: 1px solid #ddd; padding: 20px; border-radius: 12px;
      margin-bottom: 20px; background: white; box-shadow: 0 4px 12px rgba(0,0,0,0.08);
    }
    #readings { font-size: 1.1rem; line-height: 1.6; color: #2980b9; }
    .btn-back { padding: 10px 20px; background: #95a5a6; color: white; text-decoration: none; border-radius: 5px; display: inline-block; margin-bottom: 20px; }
    canvas { max-height: 220px; }
    
    /* Search & Table UI */
    .search-box { display: flex; gap: 10px; margin-bottom: 20px; }
    input { flex: 1; padding: 10px; border: 1px solid #ccc; border-radius: 5px; }
    .btn-add { padding: 10px 20px; background: #3498db; color: white; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; }
    table { width:100%; border-collapse: collapse; text-align:center; }
    th, td { border:1px solid #ccc; padding:10px; }
    .delete-btn { color: #e74c3c; cursor: pointer; font-weight: bold; border: none; background: none; }
  </style>
</head>

<body>

<a href="index.html" class="btn-back">‚¨Ö Back to Home</a>
<h2>ESP32 Weather & Water Dashboard</h2>

<div class="card">
  <h3>Live Status</h3>
  <div id="readings">Connecting to Firebase...</div>
</div>

<div class="card">
  <h3>Temperature Trend (¬∞C)</h3>
  <canvas id="tempChart"></canvas>
</div>

<div class="card">
  <h3>Humidity Trend (%)</h3>
  <canvas id="humChart"></canvas>
</div>

<div class="card">
  <h3>Global City Monitoring (Auto-Updating)</h3>
  
  <div class="search-box">
    <input type="text" id="citySearch" placeholder="Enter city name (e.g. London, Tokyo)">
    <button class="btn-add" onclick="addNewCity()">Add City</button>
  </div>

  <table>
    <thead>
      <tr style="background:#ecf0f1;">
        <th>City</th>
        <th>Temp (¬∞C)</th>
        <th>Humidity (%)</th>
        <th>Action</th>
      </tr>
    </thead>
    <tbody id="cityTableBody">
      </tbody>
  </table>
  <p id="city-sync" style="font-size: 0.8rem; color: gray; text-align: right; margin-top: 10px;">Syncing city data...</p>
</div>

<script>
/* ===================== FIREBASE & CHART CODE (UNTOUCHED) ===================== */
const firebaseConfig = { databaseURL: "https://esp32-dht22-1dcca-default-rtdb.firebaseio.com/" };
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

let tempData = { labels: [], data: [] };
let humData  = { labels: [], data: [] };

const commonOptions = { 
    responsive: true, maintainAspectRatio: false, animation: false,
    scales: { x: { display: true, title: { display: true, text: 'Time' } } } 
};

// Temp Chart Init
const tempChart = new Chart(document.getElementById('tempChart'), {
    type: 'line',
    data: { labels: tempData.labels, datasets: [{ label: 'Temp ¬∞C', data: tempData.data, borderColor: '#e74c3c', tension: 0.3, fill: true, backgroundColor: 'rgba(231, 76, 60, 0.1)' }] },
    options: commonOptions
});

// Hum Chart Init
const humChart = new Chart(document.getElementById('humChart'), {
    type: 'line',
    data: { labels: humData.labels, datasets: [{ label: 'Humidity %', data: humData.data, borderColor: '#3498db', tension: 0.3, fill: true, backgroundColor: 'rgba(52, 152, 219, 0.1)' }] },
    options: commonOptions
});

db.ref("esp32").on("value", (snapshot) => {
    const data = snapshot.val();
    if (!data) return;
    const ts = new Date().toLocaleTimeString();
    
    // Using your Firebase data keys
    const currentTemp = data.temperature; 
    const currentHum  = data.humidity;

    document.getElementById('readings').innerHTML = `
        <strong>Last Sync:</strong> ${ts}<br>
        üå°Ô∏è <strong>Temp:</strong> ${currentTemp ?? '--'}¬∞C | 
        üíß <strong>Humidity:</strong> ${currentHum ?? '--'}% 
    `;

    // Update Temp Chart
    tempChart.data.labels.push(ts);
    tempChart.data.datasets[0].data.push(currentTemp);
    if (tempChart.data.labels.length > 20) { tempChart.data.labels.shift(); tempChart.data.datasets[0].data.shift(); }
    tempChart.update();

    // Update Hum Chart
    humChart.data.labels.push(ts);
    humChart.data.datasets[0].data.push(currentHum);
    if (humChart.data.labels.length > 20) { humChart.data.labels.shift(); humChart.data.datasets[0].data.shift(); }
    humChart.update();
});

/* ===================== AUTOMATIC CITY SEARCH LOGIC ===================== */
const API_KEY = "db298b17c3864eafbb654017260302";
let myCities = ["Mumbai", "Delhi", "Pune"]; 

async function refreshAllCities() {
    const tableBody = document.getElementById('cityTableBody');
    tableBody.innerHTML = ""; 

    for (let city of myCities) {
        try {
            const response = await fetch(`https://api.weatherapi.com/v1/current.json?key=${API_KEY}&q=${city}`);
            const data = await response.json();
            
            const row = `<tr>
                <td>${data.location.name}</td>
                <td>${data.current.temp_c}¬∞C</td>
                <td>${data.current.humidity}%</td>
                <td><button class="delete-btn" onclick="removeCity('${city}')">Remove</button></td>
            </tr>`;
            tableBody.innerHTML += row;
        } catch (error) {
            console.error("Error loading " + city);
        }
    }
    document.getElementById('city-sync').innerText = "Last Automatic Sync: " + new Date().toLocaleTimeString();
}

function addNewCity() {
    const input = document.getElementById('citySearch');
    const newCity = input.value.trim();
    if (newCity && !myCities.includes(newCity)) {
        myCities.push(newCity);
        input.value = ""; 
        refreshAllCities();
    }
}

function removeCity(cityToRemove) {
    myCities = myCities.filter(c => c !== cityToRemove);
    refreshAllCities();
}

refreshAllCities();
setInterval(refreshAllCities, 600000); // 10 minute auto-update

</script>
</body>
</html>
